<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Interview Proctoring - Demo Client</title>
    <!-- Using REST API - no WebSocket dependency needed -->
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252542;
            --accent: #7c3aed;
            --accent-light: #a78bfa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #3f3f5a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--accent-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .video-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge.recording {
            background: rgba(239, 68, 68, 0.9);
            animation: pulse 2s infinite;
        }

        .status-badge.connected {
            background: rgba(16, 185, 129, 0.9);
        }

        .status-badge.disconnected {
            background: rgba(107, 114, 128, 0.9);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-light);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .metric-item {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-light);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-fill.excellent { background: var(--success); }
        .progress-fill.good { background: var(--accent); }
        .progress-fill.moderate { background: var(--warning); }
        .progress-fill.poor { background: var(--danger); }

        .emotion-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .emotion-tag {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .emotion-tag.dominant {
            background: var(--accent);
            border-color: var(--accent);
        }

        .alerts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-item.critical {
            background: rgba(239, 68, 68, 0.15);
            border-left: 3px solid var(--danger);
        }

        .alert-item.warning {
            background: rgba(245, 158, 11, 0.15);
            border-left: 3px solid var(--warning);
        }

        .alert-item.info {
            background: rgba(124, 58, 237, 0.15);
            border-left: 3px solid var(--accent);
        }

        .alert-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        #logOutput {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
            color: var(--text-secondary);
        }

        .log-entry {
            margin-bottom: 4px;
        }

        .log-entry.error { color: var(--danger); }
        .log-entry.success { color: var(--success); }
        .log-entry.info { color: var(--accent-light); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• Live Interview Proctoring</h1>
            <p class="subtitle">Real-time AI-powered interview analysis with face detection, emotion tracking, and behavioral insights</p>
        </header>

        <div class="main-grid">
            <div class="video-section">
                <div class="video-container">
                    <video id="videoElement" autoplay muted playsinline></video>
                    <div class="video-overlay">
                        <span id="connectionStatus" class="status-badge disconnected">
                            <span>‚óè</span> Disconnected
                        </span>
                        <span id="faceStatus" class="status-badge" style="display: none; background: var(--warning);">
                            <span>üë§</span> Face Not Registered
                        </span>
                        <span id="recordingStatus" class="status-badge" style="display: none;">
                            <span>‚óè</span> Recording
                        </span>
                        <span id="verificationStatus" class="status-badge" style="display: none;">
                            <span>‚úì</span> Verified
                        </span>
                    </div>
                    <!-- Face capture overlay -->
                    <div id="faceCaptureOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100;">
                        <div style="text-align: center; padding: 30px;">
                            <h2 style="color: white; margin-bottom: 15px;">üì∏ Face Registration Required</h2>
                            <p style="color: #94a3b8; margin-bottom: 20px;">Position your face clearly in the frame and click "Capture Face"</p>
                            <div style="width: 200px; height: 200px; border: 3px dashed var(--accent); border-radius: 50%; margin: 0 auto 20px;"></div>
                            <button id="captureFaceBtn" class="btn btn-primary" onclick="captureFace()" style="font-size: 1.1rem; padding: 15px 30px;">
                                üì∑ Capture Face
                            </button>
                            <p id="faceCaptureFeedback" style="color: var(--warning); margin-top: 15px; display: none;"></p>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button id="registerFaceBtn" class="btn btn-secondary" onclick="showFaceRegistration()" style="display: none;">
                        üë§ Register Face
                    </button>
                    <button id="startBtn" class="btn btn-primary" onclick="startSession()">
                        ‚ñ∂ Start Session
                    </button>
                    <button id="stopBtn" class="btn btn-danger" onclick="endSession()" disabled>
                        ‚èπ End Session
                    </button>
                    <button class="btn btn-secondary" onclick="toggleSettings()">
                        ‚öô Settings
                    </button>
                </div>

                <div id="settingsPanel" class="card" style="margin-top: 20px; display: none;">
                    <div class="card-title">‚öô Settings</div>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Server URL</label>
                            <input type="text" id="serverUrl" value="http://localhost:5001">
                        </div>
                        <div class="form-group">
                            <label>Frame Interval (ms)</label>
                            <input type="number" id="frameInterval" value="1000" min="500" max="5000">
                        </div>
                        <div class="form-group">
                            <label>Job Title</label>
                            <input type="text" id="jobTitle" value="Software Engineer">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">üìã Activity Log</div>
                    <div id="logOutput"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <div class="card-title">üìä Live Metrics</div>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-value" id="eyeContactScore">--</div>
                            <div class="metric-label">Eye Contact</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="eyeContactBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="engagementScore">--</div>
                            <div class="metric-label">Engagement</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="engagementBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="confidenceScore">--</div>
                            <div class="metric-label">Confidence</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="confidenceBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="postureScore">--</div>
                            <div class="metric-label">Posture</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="postureBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üòä Current Emotion</div>
                    <div class="emotion-display" id="emotionDisplay">
                        <span class="emotion-tag">Waiting for data...</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìà Session Stats</div>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-value" id="framesAnalyzed">0</div>
                            <div class="metric-label">Frames Analyzed</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="sessionDuration">0:00</div>
                            <div class="metric-label">Duration</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="alertCount">0</div>
                            <div class="metric-label">Alerts</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="faceDetected">--</div>
                            <div class="metric-label">Face Status</div>
                        </div>
                    </div>
                </div>

                <div class="card" id="verificationCard">
                    <div class="card-title">üîê Face Verification</div>
                    <div style="text-align: center; padding: 10px;">
                        <div id="verificationIcon" style="font-size: 2.5rem; margin-bottom: 10px;">üë§</div>
                        <div id="verificationText" style="color: var(--text-secondary); font-size: 0.9rem;">Face not registered</div>
                        <div id="verificationScore" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-light); margin-top: 10px; display: none;">--</div>
                        <div id="verificationLabel" style="font-size: 0.75rem; color: var(--text-secondary); display: none;">Match Score</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">‚ö† Recent Alerts</div>
                    <div class="alerts-list" id="alertsList">
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">No alerts yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="captureCanvas" style="display: none;"></canvas>

    <script>
        let sessionId = null;
        let videoStream = null;
        let captureInterval = null;
        let sessionStartTime = null;
        let durationInterval = null;
        let isConnected = false;

        const videoElement = document.getElementById('videoElement');
        const captureCanvas = document.getElementById('captureCanvas');
        const ctx = captureCanvas.getContext('2d');

        // Get API base URL
        function getApiUrl() {
            return document.getElementById('serverUrl').value;
        }

        // Initialize camera
        async function initCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                });
                videoElement.srcObject = videoStream;
                log('Camera initialized successfully', 'success');
            } catch (error) {
                log('Failed to access camera: ' + error.message, 'error');
            }
        }

        // Test connection to server
        async function testConnection() {
            try {
                const response = await fetch(`${getApiUrl()}/health`);
                if (response.ok) {
                    const data = await response.json();
                    isConnected = true;
                    updateConnectionStatus(true);
                    log('Connected to server (REST API)', 'success');
                    return true;
                }
            } catch (error) {
                log('Connection error: ' + error.message, 'error');
            }
            isConnected = false;
            updateConnectionStatus(false);
            return false;
        }

        // Face registration state
        let faceRegistered = false;
        
        // Start session using REST API
        async function startSession() {
            const connected = await testConnection();
            if (!connected) {
                log('Cannot start session - server not reachable', 'error');
                return;
            }

            try {
                const jobTitle = document.getElementById('jobTitle').value;
                const response = await fetch(`${getApiUrl()}/api/sessions/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_data: {
                            jobTitle: jobTitle,
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    log('Session started: ' + sessionId, 'success');
                    
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    
                    // Show face registration requirement
                    if (data.face_verification_required) {
                        log('Face registration required before proceeding', 'info');
                        showFaceRegistration();
                    } else {
                        beginInterviewCapture();
                    }
                } else {
                    log('Failed to start session: ' + data.error, 'error');
                }
            } catch (error) {
                log('Error starting session: ' + error.message, 'error');
            }
        }
        
        // Show face registration overlay
        function showFaceRegistration() {
            const overlay = document.getElementById('faceCaptureOverlay');
            overlay.style.display = 'flex';
            document.getElementById('faceStatus').style.display = 'flex';
            document.getElementById('faceCaptureFeedback').style.display = 'none';
            log('Please register your face to continue', 'info');
        }
        
        // Capture face for registration
        async function captureFace() {
            if (!sessionId) {
                log('No active session', 'error');
                return;
            }
            
            const feedback = document.getElementById('faceCaptureFeedback');
            feedback.style.display = 'block';
            feedback.style.color = 'var(--accent-light)';
            feedback.textContent = 'Capturing face...';
            
            // Capture current frame
            captureCanvas.width = videoElement.videoWidth;
            captureCanvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0);
            const faceData = captureCanvas.toDataURL('image/jpeg', 0.9);
            
            try {
                const response = await fetch(`${getApiUrl()}/api/sessions/${sessionId}/register-face`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ face: faceData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    faceRegistered = true;
                    feedback.style.color = 'var(--success)';
                    feedback.textContent = '‚úì Face registered successfully! Starting interview...';
                    log('Face registered with ' + data.face_confidence.toFixed(1) + '% confidence', 'success');
                    
                    // Update UI
                    document.getElementById('faceStatus').style.background = 'var(--success)';
                    document.getElementById('faceStatus').innerHTML = '<span>‚úì</span> Face Registered';
                    
                    updateVerificationUI(true, data.face_confidence);
                    
                    // Hide overlay after short delay and start interview
                    setTimeout(() => {
                        document.getElementById('faceCaptureOverlay').style.display = 'none';
                        beginInterviewCapture();
                    }, 1500);
                } else {
                    feedback.style.color = 'var(--danger)';
                    feedback.textContent = '‚úó ' + data.error;
                    log('Face registration failed: ' + data.error, 'error');
                }
            } catch (error) {
                feedback.style.color = 'var(--danger)';
                feedback.textContent = '‚úó Network error: ' + error.message;
                log('Face registration error: ' + error.message, 'error');
            }
        }
        
        // Begin actual interview capture after face registration
        function beginInterviewCapture() {
            startCapturing();
            
            document.getElementById('recordingStatus').style.display = 'flex';
            document.getElementById('recordingStatus').classList.add('recording');
            document.getElementById('verificationStatus').style.display = 'flex';

            sessionStartTime = Date.now();
            durationInterval = setInterval(updateDuration, 1000);
            
            log('Interview capture started', 'success');
        }
        
        // Update face verification UI
        function updateVerificationUI(verified, similarity) {
            const icon = document.getElementById('verificationIcon');
            const text = document.getElementById('verificationText');
            const score = document.getElementById('verificationScore');
            const label = document.getElementById('verificationLabel');
            const status = document.getElementById('verificationStatus');
            
            if (verified === null) {
                icon.textContent = '‚ùì';
                text.textContent = 'No face detected';
                text.style.color = 'var(--warning)';
                status.style.background = 'var(--warning)';
                status.innerHTML = '<span>?</span> No Face';
            } else if (verified) {
                icon.textContent = '‚úÖ';
                text.textContent = 'Identity Verified';
                text.style.color = 'var(--success)';
                score.style.display = 'block';
                label.style.display = 'block';
                score.textContent = similarity.toFixed(1) + '%';
                score.style.color = 'var(--success)';
                status.style.background = 'var(--success)';
                status.innerHTML = '<span>‚úì</span> Verified ' + similarity.toFixed(0) + '%';
            } else {
                icon.textContent = '‚ö†Ô∏è';
                text.textContent = 'Face Mismatch Detected!';
                text.style.color = 'var(--danger)';
                score.style.display = 'block';
                label.style.display = 'block';
                score.textContent = similarity.toFixed(1) + '%';
                score.style.color = 'var(--danger)';
                status.style.background = 'var(--danger)';
                status.innerHTML = '<span>‚úó</span> Mismatch ' + similarity.toFixed(0) + '%';
            }
        }

        // Legacy function for compatibility
        function initiateSession() {
            // Now handled by startSession directly
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('recordingStatus').style.display = 'flex';
            document.getElementById('recordingStatus').classList.add('recording');

            sessionStartTime = Date.now();
            durationInterval = setInterval(updateDuration, 1000);
        }

        // Start capturing frames
        function startCapturing() {
            const interval = parseInt(document.getElementById('frameInterval').value) || 1000;
            
            captureInterval = setInterval(() => {
                if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                    captureAndSendFrame();
                }
            }, interval);

            log('Started capturing frames every ' + interval + 'ms', 'info');
        }

        // Capture and send a frame using REST API
        async function captureAndSendFrame() {
            if (!sessionId) return;
            
            captureCanvas.width = videoElement.videoWidth;
            captureCanvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0);
            
            const frameData = captureCanvas.toDataURL('image/jpeg', 0.8);
            
            try {
                const response = await fetch(`${getApiUrl()}/api/sessions/${sessionId}/frame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame: frameData })
                });
                
                const data = await response.json();
                
                if (data.success && data.result) {
                    updateMetrics(data.result);
                    
                    // Handle alerts
                    if (data.result.alerts && data.result.alerts.length > 0) {
                        displayAlerts(data.result.alerts);
                    }
                }
            } catch (error) {
                console.error('Frame analysis error:', error);
            }
        }

        // End session using REST API
        async function endSession() {
            if (!sessionId) {
                log('No active session to end', 'error');
                return;
            }
            
            // Stop capturing first
            stopCapturing();
            clearInterval(durationInterval);
            
            log('Ending session and generating report...', 'info');
            
            try {
                const apiUrl = getApiUrl();
                const endpointUrl = `${apiUrl}/api/sessions/${sessionId}/end`;
                console.log('Calling end session:', endpointUrl);
                
                const response = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    log('Failed to parse response: ' + responseText, 'error');
                    return;
                }
                
                console.log('Parsed data:', data);
                
                if (data.report) {
                    log('Session ended. Final report generated!', 'success');
                    console.log('Final Report:', data.report);
                    showFinalReport(data.report);
                } else if (data.error) {
                    log('Server error: ' + data.error, 'error');
                } else {
                    log('Unexpected response: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                console.error('End session error:', error);
                log('Error ending session: ' + error.message, 'error');
            } finally {
                // Reset UI regardless of success/failure
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordingStatus').style.display = 'none';
                sessionId = null;
            }
        }

        // Stop capturing
        function stopCapturing() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
        }

        // Update metrics display
        function updateMetrics(result) {
            if (result.error) return;

            const metrics = result.metrics || {};
            
            updateMetricDisplay('eyeContact', metrics.eye_contact);
            updateMetricDisplay('engagement', metrics.engagement);
            updateMetricDisplay('confidence', metrics.confidence);
            updateMetricDisplay('posture', metrics.posture);

            // Update face status
            const faceStatus = result.face_count > 0 ? '‚úì' : '‚úó';
            document.getElementById('faceDetected').textContent = faceStatus;

            // Update face verification status
            if (result.face_verification) {
                const fv = result.face_verification;
                updateVerificationUI(fv.verified, fv.similarity || 0);
                
                // Log verification warnings
                if (fv.verified === false) {
                    log('‚ö†Ô∏è Face verification failed: ' + fv.message, 'error');
                }
            }

            // Update emotions
            if (result.emotions) {
                updateEmotionDisplay(result.emotions, result.dominant_emotion);
            }

            // Update frames count
            document.getElementById('framesAnalyzed').textContent = result.frame_number || 0;

            // Handle alerts
            if (result.alerts && result.alerts.length > 0) {
                displayAlerts(result.alerts);
            }
        }

        function updateMetricDisplay(name, value) {
            const scoreEl = document.getElementById(name + 'Score');
            const barEl = document.getElementById(name + 'Bar');
            
            if (scoreEl && value !== undefined) {
                scoreEl.textContent = value + '%';
                
                if (barEl) {
                    barEl.style.width = value + '%';
                    barEl.className = 'progress-fill ' + getScoreClass(value);
                }
            }
        }

        function getScoreClass(value) {
            if (value >= 80) return 'excellent';
            if (value >= 65) return 'good';
            if (value >= 50) return 'moderate';
            return 'poor';
        }

        function updateEmotionDisplay(emotions, dominant) {
            const container = document.getElementById('emotionDisplay');
            container.innerHTML = '';

            // Sort emotions by confidence
            const sorted = Object.entries(emotions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 4);

            sorted.forEach(([emotion, confidence]) => {
                const tag = document.createElement('span');
                tag.className = 'emotion-tag' + (emotion === dominant ? ' dominant' : '');
                tag.textContent = `${emotion} ${Math.round(confidence)}%`;
                container.appendChild(tag);
            });
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsList');
            const currentCount = parseInt(document.getElementById('alertCount').textContent) || 0;
            document.getElementById('alertCount').textContent = currentCount + alerts.length;

            alerts.forEach(alert => {
                const alertEl = document.createElement('div');
                alertEl.className = 'alert-item ' + alert.severity;
                alertEl.innerHTML = `
                    <span>${alert.message}</span>
                    <span class="alert-time">${formatTime(alert.timestamp)}</span>
                `;
                
                if (container.querySelector('p')) {
                    container.innerHTML = '';
                }
                container.insertBefore(alertEl, container.firstChild);
            });
        }

        function updateAggregatedMetrics(data) {
            if (data.metrics) {
                updateMetricDisplay('eyeContact', data.metrics.avg_eye_contact);
                updateMetricDisplay('engagement', data.metrics.avg_engagement);
                updateMetricDisplay('confidence', data.metrics.avg_confidence);
            }
            
            document.getElementById('framesAnalyzed').textContent = data.frames_analyzed || 0;
        }

        function updateDuration() {
            if (!sessionStartTime) return;
            
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionDuration').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'status-badge connected';
                statusEl.innerHTML = '<span>‚óè</span> Connected';
            } else {
                statusEl.className = 'status-badge disconnected';
                statusEl.innerHTML = '<span>‚óè</span> Disconnected';
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        let lastReport = null;
        
        function downloadReport() {
            if (!lastReport) return;
            const dataStr = JSON.stringify(lastReport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview-report-${lastReport.session_id || 'session'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showFinalReport(report) {
            console.log('=== FINAL INTERVIEW REPORT ===');
            console.log('showFinalReport called with:', report);
            console.log(JSON.stringify(report, null, 2));
            
            if (!report) {
                log('No report data received!', 'error');
                alert('No report data received from server');
                return;
            }
            
            lastReport = report; // Store for download
            log('Displaying report modal...', 'info');
            
            // Extract data from report
            const behavioral = report.behavioral_analysis || {};
            const bodyLang = report.body_language_analysis || {};
            const culturalFit = report.cultural_fit_analysis || {};
            const overallBehavior = report.overall_behavior_analysis || {};
            const insights = report.video_analysis_insights || {};
            const sessionSummary = report.session_summary || {};
            const faceVerification = report.face_verification_summary || {};
            
            // Calculate overall average (use overall_behavior_analysis if available, else calculate)
            const overallAverage = overallBehavior.overallAveragePercentage || Math.round(
                (
                    (behavioral.eye_contact || 0) * 0.20 +
                    (behavioral.confidence || 0) * 0.20 +
                    (behavioral.engagement || 0) * 0.15 +
                    (behavioral.facial_expressions || 0) * 0.15 +
                    (behavioral.posture || 0) * 0.12 +
                    (behavioral.voice_tone || 0) * 0.10 +
                    (behavioral.gestures || 0) * 0.08
                )
            );
            
            // Create modal HTML
            const modalHtml = `
                <div id="reportModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    overflow-y: auto;
                    padding: 20px;
                ">
                    <div style="
                        background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
                        border-radius: 20px;
                        padding: 30px;
                        max-width: 800px;
                        width: 100%;
                        max-height: 90vh;
                        overflow-y: auto;
                        border: 1px solid #3f3f5a;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    ">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <h2 style="color: #a78bfa; margin: 0; font-size: 1.8rem;">üìä Session Report</h2>
                            <p style="color: #94a3b8; margin-top: 8px;">
                                Duration: ${Math.round(sessionSummary.duration_seconds || 0)}s | 
                                Frames Analyzed: ${sessionSummary.frames_analyzed || 0} |
                                Alerts: ${sessionSummary.total_alerts || 0}
                            </p>
                        </div>
                        
                        <!-- Overall Score -->
                        <div style="
                            text-align: center;
                            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
                            border-radius: 15px;
                            padding: 25px;
                            margin-bottom: 25px;
                        ">
                            <div style="font-size: 3.5rem; font-weight: bold; color: white;">${overallAverage}%</div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 1.1rem;">Overall Performance Score</div>
                        </div>
                        
                        <!-- Face Verification Summary -->
                        ${faceVerification.registered ? `
                        <div style="
                            background: ${faceVerification.verification_rate >= 90 ? 'rgba(16, 185, 129, 0.15)' : faceVerification.verification_rate >= 70 ? 'rgba(245, 158, 11, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                            border-radius: 12px;
                            padding: 15px 20px;
                            margin-bottom: 25px;
                            border-left: 4px solid ${faceVerification.verification_rate >= 90 ? '#10b981' : faceVerification.verification_rate >= 70 ? '#f59e0b' : '#ef4444'};
                        ">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <h4 style="color: ${faceVerification.verification_rate >= 90 ? '#10b981' : faceVerification.verification_rate >= 70 ? '#f59e0b' : '#ef4444'}; margin: 0 0 8px 0;">
                                        üîê Face Verification ${faceVerification.verification_rate >= 90 ? 'Passed' : faceVerification.verification_rate >= 70 ? 'Warning' : 'Failed'}
                                    </h4>
                                    <p style="color: #94a3b8; margin: 0; font-size: 0.9rem;">
                                        ${faceVerification.successful_verifications || 0} of ${faceVerification.total_verifications || 0} frames verified 
                                        (${faceVerification.verification_rate || 0}% success rate)
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 2rem; font-weight: bold; color: ${faceVerification.verification_rate >= 90 ? '#10b981' : faceVerification.verification_rate >= 70 ? '#f59e0b' : '#ef4444'};">
                                        ${faceVerification.average_similarity || 0}%
                                    </div>
                                    <div style="font-size: 0.75rem; color: #94a3b8;">Avg Match Score</div>
                                </div>
                            </div>
                            ${faceVerification.total_mismatches > 0 ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: #ef4444; font-size: 0.85rem;">‚ö†Ô∏è ${faceVerification.total_mismatches} face mismatch(es) detected during session</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : `
                        <div style="background: rgba(107, 114, 128, 0.15); border-radius: 12px; padding: 15px 20px; margin-bottom: 25px; border-left: 4px solid #6b7280;">
                            <h4 style="color: #6b7280; margin: 0;">üîê Face Verification Not Enabled</h4>
                            <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 0.9rem;">No face was registered for this session</p>
                        </div>
                        `}
                        
                        <!-- Metrics Grid -->
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-bottom: 25px;
                        ">
                            ${createMetricCard('üëÅÔ∏è Eye Contact', behavioral.eye_contact)}
                            ${createMetricCard('üí™ Engagement', behavioral.engagement)}
                            ${createMetricCard('üòä Confidence', behavioral.confidence)}
                            ${createMetricCard('üßç Posture', behavioral.posture)}
                            ${createMetricCard('üòÄ Expressions', behavioral.facial_expressions)}
                            ${createMetricCard('üé§ Voice Tone', behavioral.voice_tone)}
                        </div>
                        
                        <!-- Body Language & Cultural Fit -->
                        <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin-bottom: 25px;
                        ">
                            <div style="background: #1a1a2e; border-radius: 12px; padding: 20px;">
                                <h4 style="color: #a78bfa; margin: 0 0 10px 0;">üé≠ Body Language</h4>
                                <div style="font-size: 2rem; color: white; font-weight: bold;">${bodyLang.overallAveragePercentage || 0}%</div>
                                <p style="color: #94a3b8; font-size: 0.85rem; margin-top: 8px;">${bodyLang.summary || 'N/A'}</p>
                            </div>
                            <div style="background: #1a1a2e; border-radius: 12px; padding: 20px;">
                                <h4 style="color: #a78bfa; margin: 0 0 10px 0;">üëî Cultural Fit</h4>
                                <div style="font-size: 2rem; color: white; font-weight: bold;">${culturalFit.overallAveragePercentage || 0}%</div>
                                <p style="color: #94a3b8; font-size: 0.85rem; margin-top: 8px;">${culturalFit.summary || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Emotion Summary -->
                        ${behavioral.emotion_summary ? `
                        <div style="background: #1a1a2e; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                            <h4 style="color: #a78bfa; margin: 0 0 15px 0;">üòä Emotion Summary</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${Object.entries(behavioral.emotion_summary).map(([emotion, percentage]) => `
                                    <div style="
                                        background: ${getEmotionColor(emotion)};
                                        padding: 8px 15px;
                                        border-radius: 20px;
                                        color: white;
                                        font-size: 0.85rem;
                                    ">
                                        ${emotion}: ${Math.round(percentage)}%
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Alert Summary -->
                        ${report.alert_history && report.alert_history.length > 0 ? `
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                            <h4 style="color: #ef4444; margin: 0 0 10px 0;">‚ö†Ô∏è Alerts During Session (${report.alert_history.length})</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${getAlertSummary(report.alert_history)}
                            </div>
                        </div>
                        ` : `
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                            <h4 style="color: #10b981; margin: 0;">‚úÖ No alerts during session - Excellent!</h4>
                        </div>
                        `}
                        
                        <!-- Insights -->
                        ${insights.positive_indicators && insights.positive_indicators.length > 0 ? `
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                            <h4 style="color: #10b981; margin: 0 0 10px 0;">‚úÖ Strengths</h4>
                            <ul style="color: #f1f5f9; margin: 0; padding-left: 20px;">
                                ${(insights.positive_indicators || []).map(s => `<li style="margin-bottom: 5px;">${s}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${insights.areas_for_improvement && insights.areas_for_improvement.length > 0 ? `
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                            <h4 style="color: #f59e0b; margin: 0 0 10px 0;">üìà Areas for Improvement</h4>
                            <ul style="color: #f1f5f9; margin: 0; padding-left: 20px;">
                                ${(insights.areas_for_improvement || []).map(s => `<li style="margin-bottom: 5px;">${s}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${insights.recommendations && insights.recommendations.length > 0 ? `
                        <div style="background: rgba(124, 58, 237, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #7c3aed;">
                            <h4 style="color: #a78bfa; margin: 0 0 10px 0;">üí° Recommendations</h4>
                            <ul style="color: #f1f5f9; margin: 0; padding-left: 20px;">
                                ${(insights.recommendations || []).map(s => `<li style="margin-bottom: 5px;">${s}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${report.ai_summary ? `
                        <div style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.15) 0%, rgba(167, 139, 250, 0.15) 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(124, 58, 237, 0.3);">
                            <h4 style="color: #a78bfa; margin: 0 0 12px 0;">ü§ñ AI Analysis Summary</h4>
                            <p style="color: #f1f5f9; line-height: 1.6; margin: 0;">${report.ai_summary.summary || ''}</p>
                            ${report.ai_summary.keyStrengths && report.ai_summary.keyStrengths.length > 0 ? `
                                <div style="margin-top: 12px;">
                                    <strong style="color: #10b981;">Key Strengths:</strong>
                                    <ul style="color: #94a3b8; margin: 5px 0 0 0; padding-left: 20px;">
                                        ${report.ai_summary.keyStrengths.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${report.ai_summary.areasOfGrowth && report.ai_summary.areasOfGrowth.length > 0 ? `
                                <div style="margin-top: 12px;">
                                    <strong style="color: #f59e0b;">Areas of Growth:</strong>
                                    <ul style="color: #94a3b8; margin: 5px 0 0 0; padding-left: 20px;">
                                        ${report.ai_summary.areasOfGrowth.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${report.ai_summary.overallVideoScore ? `
                                <div style="margin-top: 15px; text-align: center;">
                                    <span style="background: #7c3aed; color: white; padding: 6px 16px; border-radius: 20px; font-weight: 600;">
                                        AI Score: ${report.ai_summary.overallVideoScore}%
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- Token Consumption (if available) -->
                        ${report.token_consumption && report.token_consumption.total_tokens > 0 ? `
                        <div style="background: #1a1a2e; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #94a3b8; margin: 0 0 10px 0;">üìä API Usage</h4>
                            <div style="display: flex; justify-content: space-around; color: #f1f5f9; font-size: 0.9rem;">
                                <span>Calls: ${report.token_consumption.total_calls || 0}</span>
                                <span>Tokens: ${report.token_consumption.total_tokens || 0}</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Close Button -->
                        <button onclick="document.getElementById('reportModal').remove()" style="
                            width: 100%;
                            padding: 15px;
                            background: #7c3aed;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#a78bfa'" onmouseout="this.style.background='#7c3aed'">
                            Close Report
                        </button>
                        
                        <!-- Download JSON Button -->
                        <button onclick="downloadReport()" style="
                            width: 100%;
                            padding: 12px;
                            background: transparent;
                            color: #a78bfa;
                            border: 1px solid #a78bfa;
                            border-radius: 10px;
                            font-size: 0.9rem;
                            cursor: pointer;
                            margin-top: 10px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(167,139,250,0.1)'" onmouseout="this.style.background='transparent'">
                            üì• Download Full Report (JSON)
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function createMetricCard(label, value) {
            const score = value || 0;
            const color = score >= 80 ? '#10b981' : score >= 60 ? '#a78bfa' : score >= 40 ? '#f59e0b' : '#ef4444';
            return `
                <div style="background: #1a1a2e; border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.8rem; color: ${color}; font-weight: bold;">${score}%</div>
                    <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">${label}</div>
                </div>
            `;
        }
        
        function getEmotionColor(emotion) {
            const colors = {
                'HAPPY': '#10b981',
                'CALM': '#3b82f6',
                'CONFUSED': '#f59e0b',
                'SURPRISED': '#8b5cf6',
                'SAD': '#6b7280',
                'ANGRY': '#ef4444',
                'DISGUSTED': '#dc2626',
                'FEAR': '#991b1b'
            };
            return colors[emotion] || '#6b7280';
        }
        
        function getAlertSummary(alerts) {
            const alertCounts = {};
            alerts.forEach(a => {
                alertCounts[a.type] = (alertCounts[a.type] || 0) + 1;
            });
            
            const alertLabels = {
                'looking_away': 'üëÄ Looking Away',
                'no_face_detected': '‚ùå No Face',
                'multiple_faces': 'üë• Multiple Faces',
                'low_engagement': 'üò¥ Low Engagement',
                'suspicious_movement': 'üö® Suspicious Movement'
            };
            
            return Object.entries(alertCounts).map(([type, count]) => `
                <span style="
                    background: rgba(239, 68, 68, 0.2);
                    color: #fca5a5;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 0.85rem;
                ">
                    ${alertLabels[type] || type}: ${count}
                </span>
            `).join('');
        }

        // Initialize on page load
        window.onload = async () => {
            initCamera();
            log('Ready to start live proctoring session (REST API mode)', 'info');
            
            // Test connection to server
            setTimeout(async () => {
                await testConnection();
            }, 1000);
        };

        // Cleanup on page unload
        window.onbeforeunload = () => {
            if (sessionId) {
                // Send sync request to end session
                navigator.sendBeacon(`${getApiUrl()}/api/sessions/${sessionId}/end`);
            }
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        };
    </script>
</body>
</html>

